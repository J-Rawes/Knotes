<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Select a File</title>
    </head>
    <body>
        <h1>Select a File</h1>
        <div id="label">No File Loaded</div>
        <button id="button">Select File</button>
        <div id="confirm" style="display: none;"></div>
        
        <script>
            //Creates button to enter a file of only certain types
            document.getElementById('button').addEventListener('click', () => { //When the button is clicked
                const input = document.createElement('input'); //Creates an input element
                input.type = 'file';
                input.accept = '.png,.jpg,.jpeg,.heic'; //Allowed file types, subject to change
                
                input.onchange = async (event) => { //Pause a moment to allow the file to be loaded
                    const file = event.target.files[0]; //Get the file
                    if(file){ //If a file is selected
                        const fileName = file.name;
                        const fileExtension = fileName.split('.').pop().toLowerCase();

                        //Displays the file name]
                        document.getElementById('label').innerText = 'File selected: ' + fileName;

                        //Checks if the file is of the correct type
                        const validExtensions = ['png', 'jpg', 'jpeg', 'heic']; //Allowed file types, subject to change
                        if(validExtensions.includes(fileExtension)){
                            document.getElementById('confirm').style.display = 'block';
                            document.getElementById('confirm').innerText = 'File is valid';
                            
                        //Convert to png if not already
                        if(fileExtension !== 'png'){
                            const temp = await convertToPng(file);
                            const newFile = fileName - fileExtension + '.png';
                            downloadBlob(temp, newFile);
                        }
                        } else {
                            document.getElementById('confirm').style.display = 'block';
                            document.getElementById('confirm').innerText = 'File is not valid';
                    }              
                }
            };
            
            input.click(); //Click the input element
            });

            //Converts the file to a png by reading the file and converting it to a data URL
            async function convertToPng(file){
                const reader = new FileReader();
                reader.readAsDataURL(file);
                return new Promise((resolve, reject) => {
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;

                        //When the image is loaded, create a canvas and draw the image on it
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            canvas.width = img.width;
                            canvas.height = img.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0);
                            resolve(canvas.toDataURL('image/png')); 
                        };
                    };
                });
            }
        
            //Trigger download by an invisible link that is automatically clicked
            function downloadBlob(blob, fileName) {
                const link = document.createElement('a'); //Creates a link element
                link.href = URL.createObjectURL(blob); //Creates a URL for the blob
                link.download = fileName;
                link.click();
            }

            
        </script>
    </body>
</html>
